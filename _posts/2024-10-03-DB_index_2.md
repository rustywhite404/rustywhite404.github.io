---
title: DB 인덱스 활용을 통한 성능개선 2  
date: 2024-10-03 18:12:18
categories: MySQL    
published: true 
tags:
- MySQL 
- 성능개선     
---

DB 인덱스 활용을 통한 성능개선 1 : https://rustywhite404.github.io/mysql/2024/10/03/DB_index_1/#  
앞선 글에서는 새로 인덱스를 거는 방법과, 어떤 경우에 인덱스를 걸어야 하는지 정리해보았다. 이번에는 이미 인덱스가 걸려있는 테이블에서 인덱스 변경이 필요한 경우 어떻게 해야 할 지, 그리고 인덱스 별 처리 시간은 어떻게 차이를 확인해야 할 지 알아보기로 했다.  
> ex) A테이블에 a, b라는 인덱스가 걸려 있다. 쿼리 성능이 좋지 않아 실행 계획을 확인해보니 a테이블의 카디널리티 수치가 더 좋은데도 b 인덱스를 타고 있다. 이런 경우 `힌트 기능을 활용하여 a 인덱스를 타도록 설정` 해줄 수 있다.  

### 1. 힌트를 이용해서 참조할 인덱스를 변경해보자      
![이미지](https://i.imgur.com/Hcp1kyD.png)  
우선 어떤 인덱스가 걸려있는지 확인해보자. 위와 같이 `createDate`, `who` 컬럼에 대해 인덱스를 작성해두었다.  

![이미지](https://i.imgur.com/EwZm1OE.png)  
실행 계획을 확인해보면, 카디널리티 수치가 더 높은 createDate 컬럼의 인덱스를 참조하고 있다. 하지만 지금은 who컬럼의 인덱스를 타도록 만들어야 하는 상황이라고 가정하고, 힌트 기능을 이용해서 강제로  `idx_notice_who` 인덱스를 사용하도록 만들어보자.  

```sql  
explain
SELECT * FROM notice use index(idx_notice_who)
WHERE who = 'rustywhite404'
and
    createDate BETWEEN '2023-01-15 00:00:00' AND '2023-01-15 23:59:59'
;
```  
![이미지](https://i.imgur.com/HUPH2qQ.png)  
`use index(사용할 인덱스명)`을 선언해준 후 실행계획을 확인해보면 `idx_notice_who` 인덱스를 타는 것을 확인 할 수 있다.  


### 2. MySQL Profiling으로 쿼리 처리 속도 확인해보기  
카디널리티 수치가 높다고 해서 무조건 그 컬럼에 인덱스를 걸어야 하는 건 아니다. 인덱스를 걸어본 후 전후 비교를 통해 판단을 해야 하는데, MySQL Profiling으로 쿼리 처리 속도를 비교해 볼 수 있다.  

1. 프로파일링 기능 활성화 여부 확인 
```sql  
show variables like '%profiling%';  
```  
![이미지](https://i.imgur.com/WLAkd2w.png)   
지금은 OFF로 되어있는 게 보인다. profiling 기능을 활성화 해주자.  
```sql 
// profiling 기능 활성화하기
set profiling=1;
set profiling_history_size=100; 
```  

2. 확인하고자 하는 쿼리를 우선 한 번 실행(query_id를 찾기 위함)한 후 show profiles.   
![이미지](https://i.imgur.com/8O0df1F.png)  
```sql  
SELECT * FROM study_db.notice
WHERE createDate BETWEEN '2023-01-15 00:00:00' AND '2023-02-14 23:59:59'
;
show profiles ;
```  
`show profiles`를 입력해보면 앞서 실행한 쿼리들과 query_id를 확인 할 수 있다. 지금 실행 속도를 확인해 볼 query_id는 5번이 되겠다.  

3. 찾은 query_id에 대해 profiling 기능으로 확인하기  
```sql  
//해당 쿼리문의 수행시간 분석   
show profile for query 5;  
//해당 쿼리문의 CPU 사용량 분석 
show profile cpu for query 5; 
```  
![이미지](https://i.imgur.com/YVyJgeH.png)  
![이미지](https://i.imgur.com/xFFryBI.png)  
CPU 외에도 아래 항목들에 대해 분석 할 수 있다.  
- BLOCK IO
- MEMORY
- CPU
- CONTEXT SWITCHES
- IPC
- PAGE FAULTS
- SOURCE
- SWAPS  

4. profiling 기능을 활용하여 전후비교  
![이미지](https://i.imgur.com/xVitmne.png) 
소요시간을 확인해보면 인덱스를 건 후의 쿼리 실행 속도가 훨씬 빨라졌다는 것을 알 수 있다.  

### 3. nGrinder로 쿼리 처리 속도 확인해보기  
